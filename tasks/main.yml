- name: Check if reboot is required
  stat:
    path: /var/run/reboot-required
  register: reboot_required_file

# In a normal play, the pause action is only executed once, not once-per-host.
# In this case, we really want to force the once-per-host thing.
# ref http://stackoverflow.com/a/35169496
- name: Prompt for rebooting
  pause:
    prompt: "About to reboot {{ item }}. Abort now if you don't want that"
  when: "hostvars[item]['reboot_required_file'].stat.exists"
  with_items: "{{ play_hosts }}"

# ref https://support.ansible.com/hc/en-us/articles/201958037-Reboot-a-server-and-wait-for-it-to-come-back
- name: Rebooting machine
  shell: sleep 2 && shutdown -r now "Ansible updates triggered"
  async: 1
  poll: 0
  ignore_errors: true
  when: reboot_required_file.stat.exists

- name: Waiting for the machine to come back
  local_action: wait_for host={{ ansible_host }} state=started port=22 delay=30
  become: no
  when: reboot_required_file.stat.exists
